import ../../xsdk ;

import errors ;

local xsdk-root = [ xsdk.root ] ;

if ! $(xsdk-root)
{
  errors.user-error "The XSDK root is not defined, so the HDF file is not available." ;
}

local hdf = $(xsdk-root)/data/embeddedsw/lib/hwplatform_templates/ZCU102_hw_platform/system.hdf ;

local variant-desired = debug release ;
# @todo xilkernel is not exactly supported by XSDK
# local target-os-desired = elf freertos xilkernel ;
local target-os-desired = elf freertos ;
local processor-desired = cortex-a53 cortex-r5 ;

for local processor in $(processor-desired)
{
  if elf in $(target-os-desired)
  {
    # @todo add more configurations
    xsdkws elf-$(processor)-ws
      : # sources
        $(hdf)
      : # requirements
        <target-os>elf

        <link>static

        <processor>$(processor)

        <xsdk-library>xilffs

        <xsdk-configuration>"sleep_timer psu_ttc_3"
      : # default-build
      : # usage-requirements
      ;
  }

  if freertos in $(target-os-desired)
  {
    # @todo add more configurations
    xsdkws freertos-$(processor)-ws
      : # sources
        $(hdf)
      : # requirements
        <target-os>freertos

        <link>static

        <processor>$(processor)

        <xsdk-library>xilffs
      : # default-build
      : # usage-requirements
      ;
  }

  if xilkernel in $(target-os-desired)
  {
    # @todo add more configurations
    xsdkws xilkernel-$(processor)-ws
      : # sources
        $(hdf)
      : # requirements
        <target-os>xilkernel

        <link>static

        <processor>$(processor)
      : # default-build
      : # usage-requirements
      ;
   }
}

for local variant in $(variant-desired)
{
  for local target-os in $(target-os-desired)
  {
    for local processor in $(processor-desired)
    {
      exe example-$(variant)-$(target-os)-$(processor)
        : # sources
          ../example.cpp

          $(target-os)-$(processor)-ws
        : # requirements
          <variant>$(variant)

          <target-os>$(target-os)

          <link>static

          <processor>$(processor)

          <processor>cortex-a53:<toolset>gcc-7xilinxaarch64
          <processor>cortex-r5:<toolset>gcc-7xilinxarmr5
        : # default-build
        : # usage-requirements
        ;
    }
  }
}
